<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>众拼商城多商品多期版</title>
<style>
body{font-family:Arial,sans-serif;background:#f5f5f5;margin:0;padding:0;}
.header{text-align:center;padding:20px;background:#333;color:#fff;font-size:18px;}
.wallet-btn{display:block;margin:20px auto;padding:10px 20px;font-size:16px;}
.container{max-width:700px;margin:20px auto;}
.product-card{background:#fff;padding:15px;margin-bottom:20px;border-radius:8px;box-shadow:0 2px 5px rgba(0,0,0,0.1);}
.product-title{font-weight:bold;font-size:16px;margin-bottom:5px;}
.product-info{font-size:14px;margin-bottom:10px;}
.progress{height:10px;background:#eee;border-radius:5px;overflow:hidden;margin-bottom:10px;}
.progress-bar{height:100%;width:0%;background:#4caf50;}
.calc-table{width:100%;border-collapse:collapse;margin-top:10px;}
.calc-table th,.calc-table td{border:1px solid #ccc;padding:5px;font-size:12px;text-align:center;}
.calc-result{margin-top:5px;font-size:14px;color:#e91e63;font-weight:bold;}
.hidden{display:none;}
.pay-section{margin-bottom:10px;}
.qr-section{margin-top:10px;text-align:center;}
.countdown{font-size:14px;color:#ff5722;margin:5px 0;}
.celebrate{font-size:16px;color:#ff9800;text-align:center;margin:10px 0;}
input[type=number]{width:60px;padding:3px;}
</style>
</head>
<body>

<div class="header">众拼商城多商品多期版</div>
<button class="wallet-btn" id="connectWallet">连接钱包</button>

<div class="container" id="productList">

  <!-- 商品模板 -->
</div>

<script src="https://cdn.jsdelivr.net/npm/web3/dist/web3.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<script>
let isWalletConnected=false;
let userAddress='';
const crcContract='0x5b2fe2b06e714b7bea4fd35b428077d850c48087';
const productList=document.getElementById('productList');

const celebrateImages=[
  'https://i.imgur.com/1.png',
  'https://i.imgur.com/2.png',
  'https://i.imgur.com/3.png',
  'https://i.imgur.com/4.png',
  'https://i.imgur.com/5.png',
  'https://i.imgur.com/6.png',
  'https://i.imgur.com/7.png',
  'https://i.imgur.com/8.png',
  'https://i.imgur.com/9.png',
  'https://i.imgur.com/10.png'
];

// 多商品配置，可扩展
const products=[
  {id:'10001',name:'商品A',unit:5,total:10,stock:5,maxPerPay:50000},
  {id:'10002',name:'商品B',unit:10,total:20,stock:8,maxPerPay:50000}
];

// 渲染商品
products.forEach(prod=>{
  const card=document.createElement('div');
  card.className='product-card';
  card.dataset.productId=prod.id;
  card.dataset.unit=prod.unit;
  card.dataset.total=prod.total;
  card.dataset.stock=prod.stock;
  card.dataset.maxperpay=prod.maxPerPay;
  card.innerHTML=`
    <div class="product-title">${prod.name}（商品编码:${prod.id}）</div>
    <div class="product-info">
      库存: <span class="stock">${prod.stock}</span> &nbsp;|&nbsp;
      总需人次: <span class="total">${prod.total}</span> &nbsp;|&nbsp;
      已参与: <span class="participated">0</span> &nbsp;|&nbsp;
      每人次 CRC: <span class="unit">${prod.unit}</span>
    </div>
    <div class="progress"><div class="progress-bar"></div></div>

    <div class="pay-section">
      人次: <input type="number" class="buy-times" value="1" min="1" max="${prod.maxPerPay}">
      <button class="pay-btn">拼团支付</button>
    </div>

    <div class="countdown hidden">计算中: 30 秒</div>
    <div class="celebrate hidden">
      <img src="" class="celebrate-img" width="100"><br>
      🎉 中奖地址: <span class="winning-address">-</span> 🎉
    </div>

    <div class="calc-section hidden">
      <table class="calc-table">
        <thead>
          <tr><th>云付时间</th><th>转换数据</th><th>钱包地址</th></tr>
        </thead>
        <tbody class="record-list"></tbody>
      </table>
      <div class="calc-result">
        中奖码: <span class="winning-code">-</span>
      </div>
    </div>

    <div class="qr-section hidden">
      <p>扫码支付 CRC（非拼团，每次≤50000 CRC）:</p>
      <input type="number" class="qr-amount" placeholder="支付数量" min="1" max="50000">
      <button class="qr-pay-btn">扫码支付</button>
      <img class="qr-code" src="" alt="二维码" width="150">
    </div>
  `;
  productList.appendChild(card);
});

document.getElementById('connectWallet').onclick=async()=>{
  if(window.ethereum){
    try{
      const accounts=await window.ethereum.request({method:'eth_requestAccounts'});
      userAddress=accounts[0];
      isWalletConnected=true;
      alert('钱包已连接: '+userAddress);
      document.querySelectorAll('.calc-section').forEach(sec=>sec.classList.remove('hidden'));
      document.querySelectorAll('.qr-section').forEach(sec=>sec.classList.remove('hidden'));
    }catch(err){alert('连接失败');}
  }else{alert('请安装支持钱包的浏览器');}
};

productList.querySelectorAll('.product-card').forEach(card=>{
  const payBtn=card.querySelector('.pay-btn');
  const progressBar=card.querySelector('.progress-bar');
  const participatedElem=card.querySelector('.participated');
  const total=parseInt(card.dataset.total);
  const recordList=card.querySelector('.record-list');
  const winningCodeElem=card.querySelector('.winning-code');
  const winningAddressElem=card.querySelector('.winning-address');
  const countdownElem=card.querySelector('.countdown');
  const celebrateElem=card.querySelector('.celebrate');
  const celebrateImg=card.querySelector('.celebrate-img');
  const unit=parseInt(card.dataset.unit);
  const stockElem=card.querySelector('.stock');
  const buyInput=card.querySelector('.buy-times');
  const maxPerPay=parseInt(card.dataset.maxperpay);

  const qrBtn=card.querySelector('.qr-pay-btn');
  const qrInput=card.querySelector('.qr-amount');
  const qrImg=card.querySelector('.qr-code');

  let records=[];

  // 拼团支付
  payBtn.onclick=async()=>{
    if(!isWalletConnected){alert('请先连接钱包');return;}
    let buyTimes=parseInt(buyInput.value);
    if(buyTimes<1 || buyTimes>maxPerPay){alert('每次购买人次限制 1-'+maxPerPay);return;}
    if(parseInt(stockElem.innerText)<buyTimes){alert('库存不足');return;}

    try{
      const web3=new Web3(window.ethereum);
      const amount=web3.utils.toWei((unit*buyTimes).toString(),'ether');
      await web3.eth.sendTransaction({from:userAddress,to:crcContract,value:amount});
    }catch(err){alert('支付失败或取消');return;}

    for(let i=0;i<buyTimes;i++){
      let payTime=new Date();
      let timeStr=payTime.toISOString().replace('T',' ').replace('Z','');
      let convertVal=parseInt(payTime.getHours().toString().padStart(2,'0')+
                                payTime.getMinutes().toString().padStart(2,'0')+
                                payTime.getSeconds().toString().padStart(2,'0')+
                                payTime.getMilliseconds().toString().padStart(3,'0'));
      records.push({time:timeStr,value:convertVal,address:userAddress});

      let tr=document.createElement('tr');
      tr.innerHTML=`<td>${timeStr}</td><td>${convertVal}</td><td>${userAddress}</td>`;
      recordList.appendChild(tr);

      let participated=parseInt(participatedElem.innerText)+1;
      participatedElem.innerText=participated;
      progressBar.style.width=(participated/total*100)+'%';
      stockElem.innerText=Math.max(0,parseInt(stockElem.innerText)-1);

      if(participated>=total){
        countdownElem.classList.remove('hidden');
        let countdown=30;
        const timer=setInterval(()=>{
          countdownElem.innerText='计算中: '+countdown+' 秒';
          countdown--;
          if(countdown<0){
            clearInterval(timer);
            countdownElem.classList.add('hidden');
            let sum=records.slice(-100).reduce((a,b)=>a+b.value,0);
            let winningCode=(sum%total)+10000001;
            winningCodeElem.innerText=winningCode;
            winningAddressElem.innerText=records[records.length-1].address;

            celebrateImg.src=celebrateImages[Math.floor(Math.random()*celebrateImages.length)];
            celebrateElem.classList.remove('hidden');
            setTimeout(()=>{celebrateElem.classList.add('hidden');},8000);

            // 下一期可重置库存和人次
            participatedElem.innerText=0;
            stockElem.innerText=card.dataset.stock;
            progressBar.style.width='0%';
          }
        },1000);
        break;
      }
    }
  };

  // 扫码支付（非拼团）
  qrBtn.onclick=async()=>{
    if(!isWalletConnected){alert('请先连接钱包');return;}
    let amount=parseInt(qrInput.value);
    if(!amount || amount<1 || amount>50000){alert('扫码支付数量必须在1-50000 CRC'); return;}
    try{
      const web3=new Web3(window.ethereum);
      const weiAmount=web3.utils.toWei(amount.toString(),'ether');
      await web3.eth.sendTransaction({from:userAddress,to:crcContract,value:weiAmount});
      alert('扫码支付成功: '+amount+' CRC');
    }catch(err){alert('支付失败或取消'); return;}
  };

  QRCode.toDataURL(crcContract,{width:150}).then(url=>{qrImg.src=url;});
});
</script>

</body>
</html>
